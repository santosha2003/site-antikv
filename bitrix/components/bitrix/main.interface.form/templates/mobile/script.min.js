(function(){var t=window.BX;if(t&&t["Mobile"]&&t["Mobile"]["Grid"]&&t["Mobile"]["Grid"]["Form"])return;t.namespace("BX.Mobile.Grid.Form");var e={formId:{},gridId:{}},i=function(){var e=function(e,i,s){this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);this.init(e,i,s)};e.prototype={multiple:false,select:null,eventNode:null,container:null,init:function(e,i,s){if(t(e)&&e.options.length>0&&t(i)&&t(s)){e.setAttribute("bx-bound","Y");this.select=e;this.eventNode=i;this.container=s;t.bind(this.eventNode,"click",this.click);this.multiple=e.hasAttribute("multiple");this.initValues()}},initValues:function(){this.titles=[];this.values=[];this.defaultTitles=[];for(var t=0;t<this.select.options.length;t++){this.titles.push(this.select.options[t].innerHTML);this.values.push(this.select.options[t].value);if(this.select.options[t].hasAttribute("selected"))this.defaultTitles.push(this.select.options[t].innerHTML)}},click:function(e){this.show();return t.PreventDefault(e)},show:function(){BXMobileApp.UI.SelectPicker.show({callback:this.callback,values:this.titles,multiselect:this.multiple,default_value:this.defaultTitles})},callback:function(e){this.defaultTitles=[];if(e&&e.values&&e.values.length>0){var i=[],s,l;for(s=0;s<this.titles.length;s++){for(l=0;l<e.values.length;l++){if(this.titles[s]==e.values[l]){i.push(this.values[s]);this.defaultTitles.push(this.titles[s]);break}}}var n="";for(s=0;s<this.select.options.length;s++){this.select.options[s].removeAttribute("selected");if(t.util.in_array(this.select.options[s].value,i)){this.select.options[s].setAttribute("selected","selected");if(this.multiple){n+='<a href="javascript:void();">'+this.select.options[s].innerHTML+"</a>"}else{n=this.select.options[s].innerHTML}}}if(n===""&&!this.multiple)n='<span style="color:grey">'+GetMessage("interface_form_select")+"</span>";this.container.innerHTML=n;t.onCustomEvent(this,"onChange",[this,this.select])}}};return e}(),s=function(){var e=function(e,i,s,l){this.type=i;this.node=e;this.container=s;this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);t.bind(this.container,"click",this.click);this.init(l)};e.prototype={type:"datetime",format:{inner:{datetime:"dd.MM.yyyy H:mm",time:"H:mm",date:"dd.MM.yyyy"},bitrix:{datetime:null,time:null,date:null},visible:{datetime:null,time:null,date:null}},node:null,click:function(e){t.eventCancelBubble(e);this.show();return t.PreventDefault(e)},show:function(){var t={type:this.type,start_date:this.getStrDate(this.node.value),format:this.format.inner[this.type],callback:this.callback};if(t["start_date"]=="")delete t["start_date"];BXMobileApp.UI.DatePicker.setParams(t);BXMobileApp.UI.DatePicker.show()},callback:function(e){this.node.value=e;this.container.innerHTML=e;this.delButton.style.display="inline-block";t.onCustomEvent(this,"onChange",[this,this.node])},makeDate:function(e){var i=new Date;if(t.type.isNotEmptyString(e)){var s=new RegExp("(\\d{2}).(\\d{2}).(\\d{4})"),l=new RegExp("(\\d{2}):(\\d{2})"),n;if(s.test(e)&&(n=s.exec(e))&&n){i.setDate(n[1]);i.setMonth(n[2]-1);i.setFullYear(n[3])}if(l.test(e)&&(n=l.exec(e))&&n){i.setHours(n[1]);i.setMinutes(n[2])}}return i},getStrDate:function(e){var i=t.parseDate(e),s="";if(i!==null){if(this.type=="date"||this.type=="datetime"){s=t.util.str_pad_left(i.getDate().toString(),2,"0")+"."+t.util.str_pad_left(i.getMonth().toString(),2,"0")+"."+i.getFullYear().toString()}if(this.type=="datetime")s+=" ";if(this.type=="time"||this.type=="datetime"){s+=t.util.str_pad_left(i.getHours().toString(),2,"0")+":"+i.getMinutes().toString()}}return s},init:function(e){var i=t.date.convertBitrixFormat(t.message("FORMAT_DATETIME")),s=t.date.convertBitrixFormat(t.message("FORMAT_DATE")),l;if(i.substr(0,s.length)==s)l=t.util.trim(i.substr(s.length));else l=t.date.convertBitrixFormat(i.indexOf("T")>=0?"H:MI:SS T":"HH:MI:SS");this.format.bitrix.datetime=i;this.format.bitrix.date=s;this.format.bitrix.time=l;e=e||{};this.format.visible.datetime=e["datetime"]||i.replace(":s","");this.format.visible.date=e["date"]||s;this.format.visible.time=e["time"]||l.replace(":s","");this.format.visible.datetime=[["today","today, "+this.format.visible.time],["tommorow","tommorow, "+this.format.visible.time],["yesterday","yesterday, "+this.format.visible.time],["",this.format.visible.datetime]];this.format.visible.date=[["today","today"],["tommorow","tommorow"],["yesterday","yesterday"],["",this.format.visible.date]];this.delButton=t(this.node.id+"_del");t.bind(this.delButton,"click",t.proxy(function(){this.drop()},this))},drop:function(){this.node.value="";this.container.innerHTML=this.container.getAttribute("placeholder");this.delButton.style.display="none"}};return e}(),l=function(){var e=function(e,i,s){this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);this.drop=t.delegate(this.drop,this);this.select=t(e);this.eventNode=t(i);this.container=t(s);t.bind(this.eventNode,"click",this.click);this.multiple=e.hasAttribute("multiple");this.showDrop=!(e.hasAttribute("bx-can-drop")&&e.getAttribute("bx-can-drop").toString()=="false");this.actualizeNodes()};e.prototype={multiple:false,select:null,eventNode:null,container:null,showDrop:true,showMenu:false,click:function(e){this.show();return t.PreventDefault(e)},show:function(){new BXMobileApp.UI.Table({url:t.message("SITE_DIR")+"mobile/index.php?mobile_action=get_user_list",table_settings:{callback:this.callback,markmode:true,multiple:this.multiple,return_full_mode:true,skipSpecialChars:true,modal:true,alphabet_index:true,outsection:false,okname:"�������",cancelname:"��������"}},"users").show()},drop:function(){var e=t.proxy_context,i=e.id.replace(this.select.id+"_del_","");for(var s=0;s<this.select.options.length;s++){if(this.select.options[s].value+""==i+""){t.remove(t.findParent(e,{tagName:"DIV",className:"mobile-grid-field-select-user-item"}));t.remove(this.select.options[s])}}t.onCustomEvent(this,"onChange",[this,this.select])},actualizeNodes:function(){for(var e=0;e<this.select.options.length;e++){if(t(this.select.id+"_del_"+this.select.options[e].value)){t.bind(t(this.select.id+"_del_"+this.select.options[e].value),"click",this.drop)}}},callback:function(e){if(!e||!e.a_users)return;var i="",s="",l,n,o=[];for(l=0;l<this.select.options.length;l++){o.push(this.select.options[l].value.toString())}for(l=0;l<Math.min(this.multiple?e.a_users.length:1,e.a_users.length);l++){n=e.a_users[l];if(t.util.in_array(n["ID"],o))continue;i+='<option value="'+n["ID"]+'" selected>"'+t.util.htmlspecialchars(n["NAME"])+'"</option>';s+=['<div class="mobile-grid-field-select-user-item">',this.showDrop?'<del id="'+this.select.id+"_del_"+n["ID"]+'"></del>':"",'<div class="avatar"',n["IMAGE"]?" style=\"background-image:url('"+n["IMAGE"]+"')\"":"","></div>","<span>"+t.util.htmlspecialchars(n["NAME"])+"</span>","</div>"].join("").replace(" style=\"background-image:url('')\"","")}if(s!=""){this.select.innerHTML=(this.multiple?this.select.innerHTML:"")+i;this.container.innerHTML=(this.multiple?this.container.innerHTML:"")+s;t.onCustomEvent(this,"onChange",[this,this.select]);var a=0,r=t.proxy(function(){if(a<100){if(this.container.childNodes.length>0)this.actualizeNodes();else if(a++)setTimeout(r,50)}},this);setTimeout(r,50)}}};return e}(),n=function(){var e=function(e,i){this.node=e;this.container=i;this.click=t.delegate(this.click,this);this.callback=t.delegate(this.callback,this);t.bind(this.container,"click",this.click)};e.prototype={click:function(e){this.show();return t.PreventDefault(e)},show:function(){window.app.exec("showPostForm",{attachButton:{items:[]},attachFileSettings:{},attachedFiles:[],extraData:{},mentionButton:{},smileButton:{},message:{text:t.util.htmlspecialcharsback(this.node.value)},okButton:{callback:this.callback,name:t.message("interface_form_save")},cancelButton:{callback:function(){},name:t.message("interface_form_cancel")}})},callback:function(e){e.text=t.util.htmlspecialchars(e.text)||"";this.node.value=e.text;if(e.text=="")this.container.innerHTML='<span class="placeholder">'+this.node.getAttribute("placeholder")+"</span>";else this.container.innerHTML=e.text;t.onCustomEvent(this,"onChange",[this,this.node])}};return e}(),o=function(){var e=function(e){this.node=e;t.bind(this.node,"change",t.delegate(this.change,this))};e.prototype={change:function(){t.onCustomEvent(this,"onChange",[this,this.node])}};return e}();window.app.exec("enableCaptureKeyboard",true);t.Mobile.Grid.Form=function(i){BXMobileApp.UI.Page.LoadingScreen.hide();if(typeof i==="object"){this.gridId=i["gridId"]||"";this.formId=i["formId"]||"";if(this.gridId!="")e["gridId"][this.gridId]=this;if(this.formId!="")e["formId"][this.formId]=this;this.formats=i["formats"]||null;var s=i["customElements"]||[],l,n;this.apply=t.delegate(this.apply,this);while((l=s.pop())&&l){if((n=this.bindElement(t(l)))&&n){this.elements.push(n);if(i["restrictedMode"])t.addCustomEvent(n,"onChange",this.apply)}}if(t(this.formId)&&t("submit_"+this.formId)){this.click=t.delegate(this.click,this);t.bind(t("submit_"+this.formId),"click",this.click)}if(t("buttons_"+this.formId)){var o=this.formId;t.addCustomEvent("onKeyboardWillShow",function(){t.addClass(t("buttons_"+o),"mobile-grid-button-panel-regular")});t.addCustomEvent("onKeyboardDidHide",function(){t.removeClass(t("buttons_"+o),"mobile-grid-button-panel-regular")})}}};t.Mobile.Grid.Form.prototype={elements:[],bindElement:function(e){var a=null;if(t(e)){var r=e.tagName.toLowerCase(),h=e.hasAttribute("bx-type")?e.getAttribute("bx-type").toLowerCase():"";if(r=="select"&&e.getAttribute("bx-type")=="select-user"){a=new l(e,t(e.id+"_select"),t(e.id+"_target"))}else if(r=="select"){a=new i(e,t(e.id+"_select"),e.hasAttribute("multiple")?t(e.id+"_target"):t(e.id+"_select"))}else if(r=="textarea"||e.getAttribute("type")=="text"){}else if(e.getAttribute("type")=="checkbox"||e.getAttribute("type")=="radio"){a=new o(e)}else if(h=="text"||h=="textarea"){a=new n(e,t(e.id+"_target"))}else if(h=="date"||h=="datetime"||h=="time"){a=new s(e,h,t(e.id+"_container"),this.format)}else if(h=="section"){t.bind(e,"click",function(i){t.PreventDefault(i);if(t.hasClass(e,"mobile-grid-field-expanded-head")){t.removeClass(e,"mobile-grid-field-expanded-head");t.removeClass(e.nextSibling,"mobile-grid-field-expanded-body");t.addClass(e,"mobile-grid-field-collapsed-head");t.addClass(e.nextSibling,"mobile-grid-field-collapsed-body")}else{t.removeClass(e,"mobile-grid-field-collapsed-head");t.removeClass(e.nextSibling,"mobile-grid-field-collapsed-body");t.addClass(e,"mobile-grid-field-expanded-head");t.addClass(e.nextSibling,"mobile-grid-field-expanded-body")}return false})}}return a},click:function(e){t.PreventDefault(e);this.save();return false},apply:function(e,i){var s={submit:true};t.onCustomEvent(this,"onSubmitForm",[this,t(this.formId),i,s]);window.app.onCustomEvent("onSubmitForm",[this.gridId,this.formId,i?i.id:null]);if(s.submit!==false)this.submit(true)},save:function(){var e={submit:true};t.onCustomEvent(this,"onSubmitForm",[this,t(this.formId),null,e]);window.app.onCustomEvent("onSubmitForm",[this.gridId,this.formId,null]);if(e.submit!==false)this.submit(false)},submit:function(e){if(!t(this.formId))return;var i;if(e){i={save:"Y",restricted:"Y",method:t(this.formId).getAttribute("method"),onsuccess:function(){console.log("onsuccess")},onfailure:function(){console.log("onfailure")},onprogress:function(){console.log("onprogress")}};t.onCustomEvent(this,"onBeforeSubmitAjax",[this,i]);t.ajax.submitAjax(t(this.formId),i)}else{i={callback:function(){console.log("good")}};t.onCustomEvent(this,"onBeforeSubmitForm",[this,i]);BXMobileApp.UI.Page.LoadingScreen.show();t.submit(t(this.formId),"save","Y",i.callback)}}};t.Mobile.Grid.Form.getByFormId=function(t){return e["formId"][t]};t.Mobile.Grid.Form.getByGridId=function(t){return e["gridId"][t]}})();
//# sourceMappingURL=script.map.js