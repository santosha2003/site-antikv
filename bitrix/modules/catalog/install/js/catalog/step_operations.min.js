BX.namespace("BX.Catalog");BX.Catalog.StepOperations=function(){var t=function(t){this.errorCode=0;this.url="";this.stepOptions={ajaxSessionID:"",maxExecutionTime:0,maxOperationCounter:0};this.finish=false;this.currentState={counter:0,operationCounter:0,errorCounter:0,lastID:0};this.ajaxParams={};this.visual={startBtnID:"",stopBtnID:"",resultContID:"",errorContID:"",errorDivID:"",timeFieldID:""};this.buttons={start:null,stop:null};this.content={result:null,errors:null,errorsFrame:null,timeField:null};if(typeof t==="object"){if(t.url===undefined||!BX.type.isNotEmptyString(t.url))this.addError(-2);else this.url=t.url;if(t.options==="undefined"||typeof t.options!=="object"){this.addError(-4)}else{this.stepOptions.ajaxSessionID=t.options.ajaxSessionID;this.stepOptions.maxExecutionTime=t.options.maxExecutionTime;this.stepOptions.maxOperationCounter=t.options.maxOperationCounter;this.currentState.counter=t.options.counter}if(!!t.ajaxParams&&typeof t.ajaxParams==="object")this.ajaxParams=t.ajaxParams;if(!!t.visual&&typeof t.visual==="object")this.visual=t.visual}else{this.addError(-1)}if(this.errorCode===0)BX.ready(BX.proxy(this.init,this))};t.prototype.init=function(){if(this.errorCode<0)return;if(this.errorCode===0){if(!!this.visual.startBtnID){this.buttons.start=BX(this.visual.startBtnID);if(!this.buttons.start)this.addError(-131072)}else{this.addError(-65536)}if(!!this.visual.stopBtnID){this.buttons.stop=BX(this.visual.stopBtnID);if(!this.buttons.stop)this.addError(-524288)}else{this.addError(-262144)}this.content.timeField=BX(this.visual.timeFieldID)}if(this.errorCode===0){BX.bind(this.buttons.start,"click",BX.proxy(this.startOperation,this));BX.bind(this.buttons.stop,"click",BX.proxy(this.stopOperation,this));if(!!this.content.timeField)BX.bind(this.content.timeField,"change",BX.proxy(this.changeMaxTime,this))}};t.prototype.extendAjaxParams=function(){};t.prototype.initResultDom=function(){if(this.content.result===null){this.content.result=BX(this.visual.resultContID);this.content.errorsFrame=BX(this.visual.errorDivID);this.content.errors=BX(this.visual.errorContID)}};t.prototype.nextStep=function(){var t;for(t in this.stepOptions){if(this.stepOptions.hasOwnProperty(t))this.ajaxParams[t]=this.stepOptions[t]}for(t in this.currentState){if(this.currentState.hasOwnProperty(t))this.ajaxParams[t]=this.currentState[t]}this.ajaxParams.sessid=BX.bitrix_sessid();this.ajaxParams.lang=BX.message("LANGUAGE_ID");this.extendAjaxParams();BX.showWait();BX.ajax.loadJSON(this.url,this.ajaxParams,BX.proxy(this.nextStepResult,this))};t.prototype.nextStepResult=function(t){BX.closeWait();if(typeof t==="object"){this.initResultDom();this.currentState.lastID=t.lastID;this.stepOptions.maxOperationCounter=t.maxOperationCounter;this.currentState.operationCounter=parseInt(t.operationCounter,10);if(isNaN(this.currentState.operationCounter))this.currentState.operationCounter=0;this.showResult(t.message);this.currentState.errorCounter=parseInt(t.errorCounter,10);if(isNaN(this.currentState.errorCounter))this.currentState.errorCounter=0;if(this.currentState.errorCounter>0)this.showErrors(t.errors);if(this.finish)this.finishOperation();else this.checkOperation(t.finishOperation)}};t.prototype.checkOperation=function(t){if(!!t)this.finishOperation();else this.nextStep()};t.prototype.showResult=function(t){if(!!this.content.result)BX.adjust(this.content.result,{html:t,style:{display:"block"}})};t.prototype.showErrors=function(t){if(!!this.content.errors){if(BX.type.isNotEmptyString(t))this.content.errors.innerHTML=this.content.errors.innerHTML+t;BX.style(this.content.errorsFrame,"display","block")}};t.prototype.finishOperation=function(){this.currentState.operationCounter=0;this.currentState.errorCounter=0;this.currentState.lastID=0;this.buttons.start.disabled=false;this.buttons.stop.disabled=true;this.finish=false};t.prototype.startOperation=function(){if(!this.buttons.start.disabled){this.changeMaxTime();this.buttons.start.disabled=true;this.buttons.stop.disabled=false;this.nextStep()}};t.prototype.stopOperation=function(){if(!this.buttons.stop.disabled){this.buttons.start.disabled=false;this.buttons.stop.disabled=true;this.finish=true}};t.prototype.changeMaxTime=function(){var t;if(!!this.content.timeField){t=parseInt(this.content.timeField.value,10);if(!isNaN(t))this.stepOptions.maxExecutionTime=t}};t.prototype.addError=function(t){this.errorCode=this.errorCode||t};return t}();BX.Catalog.CatalogReindex=function(){var t=function(i){this.catalogs=[];this.catalogIndex=-1;this.catalogSelect=null;this.report=null;this.catalogContent=[];this.messages={catalogErrorTitle:""};t.superclass.constructor.apply(this,arguments);if(typeof this.visual.catalogSelectID==="undefined")this.visual.catalogSelectID="";if(typeof this.visual.reportID==="undefined")this.visual.reportID=""};BX.extend(t,BX.Catalog.StepOperations);t.prototype.init=function(){if(this.errorCode===0){if(!!this.visual.catalogSelectID){this.catalogSelect=BX(this.visual.catalogSelectID);if(!this.catalogSelect)this.addError(-2097152)}else{this.addError(-1048576)}if(!!this.visual.reportID){this.report=BX(this.visual.reportID);if(!this.report)this.addError(-8388608)}else{this.addError(-4194304)}}t.superclass.init.apply(this,arguments)};t.prototype.getIblockList=function(){if(this.catalogSelect.selectedIndex!=-1&&this.catalogSelect.options[this.catalogSelect.selectedIndex].value!==""){BX.showWait();BX.ajax.loadJSON(this.url,{sessid:BX.bitrix_sessid(),getIblock:"Y",iblock:this.catalogSelect.options[this.catalogSelect.selectedIndex].value},BX.proxy(this.getIblockListResult,this))}};t.prototype.getIblockListResult=function(t){BX.closeWait();if(BX.type.isArray(t)){this.catalogs=t;if(this.catalogs.length>0){this.changeMaxTime();this.buttons.start.disabled=true;this.buttons.stop.disabled=false;this.catalogIndex=0;this.catalogReindex()}else{}}};t.prototype.startOperation=function(){if(!this.buttons.start.disabled){this.clearOldReports();this.getIblockList()}};t.prototype.catalogReindex=function(){if(this.catalogs.length==0)return;if(this.catalogIndex<0)return;if(this.catalogIndex>=this.catalogs.length)return;if(this.finish)return;this.createReindexReport();this.initStep();this.nextStep()};t.prototype.createReindexReport=function(){var t;if(!this.report)return;if(this.catalogIndex>0)BX.adjust(this.catalogContent[this.catalogIndex-1].container,{style:{display:"none"}});this.catalogContent[this.catalogIndex]={container:null,result:null,errors:null,errorsFrame:null};t=this.catalogs[this.catalogIndex].ID;this.report.appendChild(BX.create("div",{props:{id:this.visual.prefix+t},html:'<div id="'+this.visual.resultContID+t+'" style="margin:0; width: 100%; display: none;"></div>'+'<div id="'+this.visual.errorDivID+t+'" style="margin:0; width: 100%; display: none;">'+'<div class="adm-info-message-wrap adm-info-message-red">'+'<div class="adm-info-message">'+'<div id="'+this.visual.errorContID+t+'"></div>'+'<div class="adm-info-message-icon"></div>'+"</div></div></div>"}))};t.prototype.initStep=function(){this.currentState.iblockId=this.catalogs[this.catalogIndex].ID;this.currentState.counter=this.catalogs[this.catalogIndex].COUNT;this.currentState.operationCounter=0;this.currentState.errorCounter=0;this.currentState.lastID=0};t.prototype.initResultDom=function(){var t;if(this.catalogs.length==0)return;if(this.catalogIndex<0)return;if(this.catalogIndex>=this.catalogs.length)return;if(this.catalogContent[this.catalogIndex].container===null){t=this.catalogs[this.catalogIndex].ID;this.catalogContent[this.catalogIndex].container=BX(this.visual.prefix+t);this.catalogContent[this.catalogIndex].result=BX(this.visual.resultContID+t);this.catalogContent[this.catalogIndex].errors=BX(this.visual.errorContID+t);this.catalogContent[this.catalogIndex].errorsFrame=BX(this.visual.errorDivID+t)}};t.prototype.checkOperation=function(t){if(!!t){this.catalogIndex++;if(this.catalogIndex>=this.catalogs.length||this.currentState.errorCounter>0){this.finishOperation();if(this.currentState.errorCounter==0)this.clearTagCache()}else{this.createReindexReport();this.initStep();this.nextStep()}}else{this.nextStep()}};t.prototype.showResult=function(t){if(this.catalogs.length==0)return;if(this.catalogIndex<0)return;if(this.catalogIndex>=this.catalogs.length)return;if(!!this.catalogContent[this.catalogIndex].container){if(!!this.catalogContent[this.catalogIndex].result)BX.adjust(this.catalogContent[this.catalogIndex].result,{html:t,style:{display:"block"}});BX.adjust(this.catalogContent[this.catalogIndex].container,{style:{display:"block"}});BX.adjust(this.report,{style:{display:"block"}})}};t.prototype.showErrors=function(t){if(this.catalogs.length==0)return;if(this.catalogIndex<0)return;if(this.catalogIndex>=this.catalogs.length)return;if(!!this.catalogContent[this.catalogIndex].container){if(!!this.catalogContent[this.catalogIndex].errors){if(BX.type.isNotEmptyString(t))this.catalogContent[this.catalogIndex].errors=this.catalogContent[this.catalogIndex].errors.innerHTML+t;BX.style(this.catalogContent[this.catalogIndex].errorsFrame,"display","block")}}};t.prototype.clearTagCache=function(){var t=[],i;if(this.catalogs.length>0){for(i=0;i<this.catalogs.length;i++)t[t.length]=this.catalogs[i].ID;BX.ajax.get(this.url,{sessid:BX.bitrix_sessid(),clearTags:"Y",iblockList:t})}};t.prototype.clearOldReports=function(){var t;if(this.catalogContent.length>0){for(t=0;t<this.catalogContent.length;t++){if(!!this.catalogContent[t].container){this.catalogContent[t].container=BX.cleanNode(this.catalogContent[t].container,true);this.catalogContent[t].result=null;this.catalogContent[t].errorsFrame=null;this.catalogContent[t].errors=null}}this.catalogContent.length=0}};return t}();
//# sourceMappingURL=step_operations.map.js