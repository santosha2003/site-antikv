BX.namespace("BX.Sale.Admin.OrderEditPage");BX.Sale.Admin.OrderEditPage={formId:"",fieldsUpdaters:{},fieldsUpdatersContexts:{},statusesNames:{},orderId:0,languageId:"",siteId:"",currency:"",currencyLang:"",form:null,adminTabControlId:"",discountRefreshTimeoutId:0,getForm:function(){if(!BX.Sale.Admin.OrderEditPage.form)BX.Sale.Admin.OrderEditPage.form=BX(BX.Sale.Admin.OrderEditPage.formId);return BX.Sale.Admin.OrderEditPage.form},toggleFix:function(e,a){var t=BX(a),r=BX(e);if(!t||!r)return;var i=!BX.hasClass(t,"adm-detail-tabs-block-pin");if(i){BX.addClass(t,"adm-detail-tabs-block-pin");r.title=BX.message("SALE_ORDEREDIT_FIX");BX.UnFix(t)}else{BX.removeClass(t,"adm-detail-tabs-block-pin");r.title=BX.message("SALE_ORDEREDIT_UNFIX");BX.Fix(t,{type:"top"});window[this.adminTabControlId].ToggleFix("top",false)}i=!i;BX.userOptions.save("sale_admin","sale_order_edit","fix_"+a,i?"Y":"N")},disableSavingButtons:function(e){var a,t,r=["apply","save"];for(a in r){t=BX.findChild(document,{attr:{name:r[a]}},true);if(t)t.disabled=e}},showDialog:function(e,a){alert(e)},onSaveStatusButton:function(e,a){BX.Sale.Admin.OrderAjaxer.sendRequest(this.ajaxRequests.saveStatus(e,a))},onCancelStatusButton:function(e,a){this.toggleCancelDialog();BX.Sale.Admin.OrderAjaxer.sendRequest(this.ajaxRequests.cancelOrder(e,a,BX("FORM_REASON_CANCELED").value))},getElementValue:function(e){var a=BX(e);if(a&&typeof a.value!="undefined")return a.value;return""},getAllFormData:function(){var e=this.getForm();if(!e)return{};var a=BX.ajax.prepareForm(e);return!!a&&a.data?a.data:{}},unRegisterFieldUpdater:function(e,a){if(!this.fieldsUpdaters[e])return;for(var t=this.fieldsUpdaters[e].length-1;t>=0;t--)if(this.fieldsUpdaters[e][t]==a)delete this.fieldsUpdaters[e][t]},unRegisterProductFieldsUpdaters:function(e){for(var a in this.fieldsUpdaters)if(a.indexOf("PRODUCT["+e+"]")!=-1)delete this.fieldsUpdaters[a]},unRegisterFieldsUpdaters:function(e){for(var a in e)if(this.fieldsUpdaters[e[a]])delete this.fieldsUpdaters[e[a]]},registerFieldsUpdaters:function(e){for(var a in e){if(typeof this.fieldsUpdaters[a]=="undefined")this.fieldsUpdaters[a]=[];this.fieldsUpdaters[a].push(e[a])}},callFieldsUpdaters:function(e){var a=["DISCOUNTS_LIST","DELIVERY_PRICE"],t={};for(var r=0,i=a.length-1;r<=i;r++){var d=a[r];if(typeof e[d]!=="undefined")this.callConcreteFieldUpdater(d,e[d]);t[d]=true}for(r in e){if(t[r])continue;this.callConcreteFieldUpdater(r,e[r])}},callConcreteFieldUpdater:function(e,a){var t=null,r=null;for(var i in this.fieldsUpdaters[e]){var d=this.fieldsUpdaters[e][i];if(d.context&&d.callback){t=d.context;r=d.callback}else{t=null;r=this.fieldsUpdaters[e][i]}if(r&&typeof r=="function")r.call(t,a)}},currencyFormat:function(e,a){if(BX.Currency&&BX.Currency.currencyFormat){e=BX.Currency.currencyFormat(e,this.currency,a?false:true)}return e},restoreFormData:function(e){var a=this.getForm();if(!a){BX.debug("BX.Sale.Admin.OrderEditPage:restoreFormData() can't find form");return false}for(var t in e)if(typeof a.elements[t]!="undefined")a.elements[t].value=e[t];return true},createFormBlocker:function(){var e=document.documentElement.scrollHeight,a=document.documentElement.clientHeight,t=Math.max(e,a);return BX.create("div",{props:{className:"bx-core-dialog-overlay",id:"sale-adm-order-form-blocker"},style:{zIndex:"10001",width:"100%",height:t+"px",backgroundColor:"rgba(57,60,67,0.1)"},children:[BX.create("span",{style:{zIndex:"10002",top:"5%",left:"85%",position:"fixed",background:'url("/bitrix/panel/main/images/submenu-bg.png") repeat 0 0',padding:"15px",borderRadius:"5px",fontSize:"14px",border:"4px solid rgb(230, 230, 230)"},html:BX.message("SALE_ORDEREDIT_REFRESHING_DATA")})]})},blockForm:function(){document.body.appendChild(this.createFormBlocker())},unBlockForm:function(){var e=BX("sale-adm-order-form-blocker");if(e)e.parentNode.removeChild(e)},toggleCancelDialog:function(){var e=BX("sale-adm-status-cancel-dialog");if(e)BX.toggleClass(e,"active")},setStatus:function(e){BX("STATUS_ID").value=e},changeCancelBlock:function(e,a){var t=BX("sale-adm-status-cancel-blocktext"),r=BX("FORM_REASON_CANCELED"),i=BX("sale-adm-status-cancel-dialog-btn"),d="";if(a.CANCELED=="Y"){d='<div class="adm-s-select-popup-element-selected-bad">'+"<span>"+BX.message("SALE_ORDER_STATUS_CANCELED")+"</span>"+a.DATE_CANCELED+'<a href="/bitrix/admin/user_edit.php?lang='+BX.Sale.Admin.OrderEditPage.languageId+"&ID="+a.EMP_CANCELED_ID+'">'+BX.util.htmlspecialchars(a.EMP_CANCELED_NAME)+"</a>"+"</div>";t.style.textAlign="start";r.disabled=true;i.innerHTML=BX.message("SALE_ORDER_STATUS_CANCEL_CANCEL");i.onclick=function(){BX.Sale.Admin.OrderEditPage.onCancelStatusButton(e,"Y")}}else{d='<a href="javascript:void(0);" onclick="BX.Sale.Admin.OrderEditPage.toggleCancelDialog();">'+BX.message("SALE_ORDER_STATUS_CANCELING")+"</a>";t.style.textAlign="center";r.disabled=false;i.innerHTML=BX.message("SALE_ORDER_STATUS_CANCEL");i.onclick=function(){BX.Sale.Admin.OrderEditPage.onCancelStatusButton(e,"N")}}t.innerHTML=d},onRefreshOrderDataAndSave:function(){BX.Sale.Admin.OrderEditPage.blockForm();var e=this.getForm();e.appendChild(BX.create("input",{props:{name:"refresh_data_and_save",type:"hidden",value:"Y"}}));e.submit()},onOrderCopy:function(e){BX.Sale.Admin.OrderEditPage.blockForm();var a=this.getForm();a.action=e;a.submit()},createDiscountsNode:function(e,a,t,r,i){var d=null;if(t&&r&&r.DISCOUNT_LIST){d=BX.create("table");for(var n=0,s=t.length;n<s;n++){if(!t[n])continue;var l=t[n].DISCOUNT_ID;if(r.DISCOUNT_LIST[l]){this.addDiscountItemRow(e,a,t[n],r.DISCOUNT_LIST[l],d,i)}}}else{d=BX.create("span",{html:"&nbsp;"})}return BX.create("div",{children:[d]})},addDiscountItemRow:function(e,a,t,r,i,d){var n=i.insertRow(-1),s={"data-discount-id":r.DISCOUNT_ID};if(a=="DISCOUNT_LIST")s["data-discount"]="Y";var l="DISCOUNTS["+a+"]"+(e!=""?"["+e+"]":"")+"["+r.DISCOUNT_ID+"]",o=BX.create("input",{props:{type:"checkbox",name:l,checked:t.APPLY=="Y",value:"Y",disabled:d=="VIEW"},attrs:s});n.appendChild(BX.create("td",{children:[BX.create("input",{props:{type:"hidden",name:l,value:"N"}}),o]}));if(d=="EDIT"){BX.bind(o,"click",function(e){BX.Sale.Admin.OrderEditPage.setDiscountCheckbox(e);BX.Sale.Admin.OrderEditPage.refreshDiscounts()})}var c="";if(typeof t.DESCR=="object"){if(t.DESCR){for(var u in t.DESCR)c+=t.DESCR[u]}else{c=BX.message("SALE_ORDEREDIT_DISCOUNT_UNKNOWN")+" %"}}else{c=t.DESCR}n.appendChild(BX.create("td",{html:"<strong>"+c+"</strong>"}));if(r.EDIT_PAGE_URL){n.appendChild(BX.create("td",{children:[BX.create("a",{props:{href:r.EDIT_PAGE_URL,className:"adm-s-detail-content-sale-link"},html:r.NAME})]}))}else{n.appendChild(BX.create("td",{children:[BX.create("span",{html:r.NAME})]}))}return n},setDiscountCheckbox:function(e){var a=e.target,t;if(!!a&&a.hasAttribute("data-discount")&&a.hasAttribute("data-discount-id")){if(a.getAttribute("data-discount")=="Y"){var r=BX.findChild(BX.Sale.Admin.OrderEditPage.getForm(),{attribute:{"data-discount-id":a.getAttribute("data-discount-id")}},true,true);if(r.length>0){for(t=0;t<r.length;t++){r[t].checked=a.checked}}}}},onProblemCloseClick:function(e,a){BX.Sale.Admin.OrderAjaxer.sendRequest(this.ajaxRequests.unmarkOrder(e,a))},refreshDiscounts:function(){if(this.discountRefreshTimeoutId>0)return;this.discountRefreshTimeoutId=setInterval(function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"DISCOUNTS_REFRESH"}));clearInterval(BX.Sale.Admin.OrderEditPage.discountRefreshTimeoutId);BX.Sale.Admin.OrderEditPage.discountRefreshTimeoutId=0},500)},ajaxRequests:{addProductToBasket:function(e,a,t,r){var i={action:"addProductToBasket",productId:e,quantity:a,replaceBasketCode:t?t:"",columns:r,callback:BX.Sale.Admin.OrderAjaxer.refreshOrderData.callback};return BX.Sale.Admin.OrderAjaxer.refreshOrderData.modifyParams(i)},cancelOrder:function(e,a,t){return{action:"cancelOrder",orderId:e,canceled:a,comment:t,callback:function(a){BX.Sale.Admin.OrderEditPage.unBlockForm();if(a&&!a.ERROR)BX.Sale.Admin.OrderEditPage.changeCancelBlock(e,a);else if(a&&a.ERROR)BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_STATUS_CANCEL_ERROR")+": "+a.ERROR);else BX.debug(BX.message("SALE_ORDER_STATUS_CANCEL_ERROR"))}}},saveStatus:function(e,a){var t=BX(a);if(!t)BX.debug("Error getting select object with id: "+a);if(typeof t.value=="undefined")BX.debug("Error getting select value id: "+a);return{action:"saveStatus",orderId:e,statusId:t.value,callback:function(e){var a;e.CAN_USER_EDIT="Y";if(e&&e.CAN_USER_EDIT&&!e.ERROR){BX.Sale.Admin.OrderEditPage.callFieldsUpdaters({STATUS_ID:t.value});BX.Sale.Admin.OrderEditPage.disableSavingButtons(e.CAN_USER_EDIT!="Y");a=BX.message("SALE_ORDER_STATUS_CHANGED_SUCCESS")}else if(e&&e.ERROR){a=BX.message("SALE_ORDER_STATUS_CHANGE_ERROR")+": "+e.ERROR}else{a=BX.message("SALE_ORDER_STATUS_CHANGE_ERROR")}BX.Sale.Admin.OrderEditPage.showDialog(a)}}},getOrderFields:function(e,a){return{action:"getOrderFields",givenFields:e.givenFields,demandFields:e.demandFields,callback:function(e){if(e&&e.RESULT_FIELDS&&!e.ERROR){BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT_FIELDS);if(a){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}}else if(e&&e.ERROR){BX.debug("Error receiving fields: "+e.ERROR)}else{BX.debug("Error receiving fields!")}}}},refreshOrderData:function(e){if(!BX.Sale.Admin.OrderAjaxer.refreshOrderData.getFlag()){return BX.Sale.Admin.OrderAjaxer.refreshOrderData.modifyParams({action:"refreshOrderData",additional:e,callback:BX.Sale.Admin.OrderAjaxer.refreshOrderData.callback})}},unmarkOrder:function(e,a){return{action:"unmarkOrder",orderId:e,callback:function(e){BX.Sale.Admin.OrderEditPage.unBlockForm();if(e&&!e.ERROR)BX(a).style.display="none";else if(e&&e.ERROR)BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDEREDIT_UNMARK_ERROR")+": "+e.ERROR);else BX.debug(BX.message("SALE_ORDEREDIT_UNMARK_ERROR"))}}}}};
//# sourceMappingURL=order_edit.map.js